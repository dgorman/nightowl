apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nightowl

resources:
  - ../../base

# Dev-specific image replacements (use local builds)
images:
  - name: registry.olympusdrive.com/nightowl-monitor
    newName: nightowl-monitor
    newTag: dev

# Patches for dev environment
patches:
  # Change service to LoadBalancer for easy local access
  - patch: |-
      - op: replace
        path: /spec/type
        value: LoadBalancer
    target:
      kind: Service
      name: nightowl-monitor

  # Use IfNotPresent for local images
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
    target:
      kind: Deployment
      name: nightowl-monitor

  # Add ML configuration environment variables
  # Note: ML_PROMETHEUS_URL is NOT set in dev - ML inference uses real-time telemetry only
  # This prevents dev from querying/affecting prod Prometheus/Grafana Cloud
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: NIGHTOWL_ML_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: NIGHTOWL_ML_MODEL_PATH
          value: "/app/models/leak_detector.joblib"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: NIGHTOWL_ML_INFERENCE_INTERVAL
          value: "5"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: NIGHTOWL_LLM_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OLLAMA_URL
          value: "http://host.docker.internal:11434"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OLLAMA_MODEL
          value: "qwen2.5:14b"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GRAFANA_CLOUD_USER
          value: "1953220"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GRAFANA_CLOUD_TOKEN
          valueFrom:
            secretKeyRef:
              name: nightowl-llm-secret
              key: grafana-cloud-token
    target:
      kind: Deployment
      name: nightowl-monitor

  # Mount local model file from host (allows updating model without rebuilding image)
  - patch: |-
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: ml-models
          hostPath:
            path: /Users/dgorman/Dev/nightowl/models
            type: Directory
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: ml-models
          mountPath: /app/models
          readOnly: true
    target:
      kind: Deployment
      name: nightowl-monitor

# Create dev secrets (using production credentials)
# Note: For multi-user support, create separate secrets per user
secretGenerator:
  - name: nightowl-secret
    literals:
      - username=dgorman@nightowl.com
      - password=REPLACE_WITH_ACTUAL_PASSWORD
      - tenant=""
  - name: nightowl-secret-demos
    literals:
      - username=demos@nightowlmonitoring.com
      - password=REPLACE_WITH_ACTUAL_PASSWORD
      - tenant=""
